<!--
  Copyright (c) 2015 Hongchan Choi. MIT License.

  @description: Main app shell for Canopy.
 -->

<!-- Polymer vanilla elements -->
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../bower_components/neon-animation/neon-animatable.html">
<link rel="import" href="../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-styles/paper-styles.html">

<!-- Canopy custom element -->
<link rel="import" href="canopy-toolbar.html">

<!-- Spiral elements -->
<link rel="import" href="../bower_components/spiral-audiograph/spiral-audiograph.html">
<link rel="import" href="../bower_components/spiral-coder/spiral-coder.html">
<link rel="import" href="../bower_components/spiral-gistloader/spiral-gistloader.html">
<link rel="import" href="../bower_components/spiral-minimap/spiral-minimap.html">
<link rel="import" href="../bower_components/spiral-waveform/spiral-waveform.html">

<!-- Canopy specific module -->
<script src="canopy-audio.js"></script>

<!-- dom-module definition -->
<dom-module id="canopy-app">

  <style is="custom-style">
    :host {
      -webkit-user-select: none;
      display: block;
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
    }

    .drawer {
      @apply(--layout-vertical);
      z-index: 9999;
    }

    .drawer .app-title {
      font-family: 'Roboto Condensed';
      font-size: 2.2em;
      font-weight: 100;
      color: #00695C;
      background-color: #B2DFDB;
      padding: 0.5em;
      margin-bottom: 0.5em;
    }

    .drawer .app-title .version {
      font-size: 0.5em;
    }

    .drawer .about {
      @apply(--layout-horizontal);
      border-top: 1px solid #E8EAF6;
      height: 64px;
    }

    .drawer .about > paper-item {
      font-size: 0.85em;
    }

    .drawer .about > paper-item > a {
      color: #455A64;
      text-decoration: none;
    }

    .workspace {
      @apply(--layout-vertical);
      z-index: 0;
    }

    #eWorkspace {
      @apply(--layout-flex);
      min-height: 256px;
      overflow: hidden;
    }

    #eWaveformView {
      @apply(--layout-vertical);
      display: block;
      min-height: 256px;
    }

    #eAudioGraphView {
      display: none;
      min-height: 256px;
    }

    #eSplitter {
      height: 16px;
      min-height: 16px;
      background-color: #484847;
      box-shadow:
        inset 0px 7px 5px -7px hsla(0, 100%, 100%, 0.45),
        inset 0px -12px 1px -11px rgba(0,0,0,0.5);
      cursor: row-resize;
    }

    .splitter-handle {
      margin: 5px auto;
      height: 3px;
      width: 100px;
      border-top: 1px solid #888888;
      border-bottom: 1px solid #888888;
    }

    #eAppShell {
    }

    #ePaneEditor {
      @apply(--layout-horizontal);
      min-height: 256px;
      overflow: hidden;
      z-index: 0;
    }

    #eMiniMap {
      height: 64px;
    }

    #eTools {
      @apply(--layout-vertical);
      color: #B7DAD7;
      background-color: #506067;
      padding-right: 4px;
      width: 40px;
    }

    #eTutorialPages {
      width: 384px;
      height: 550px;
      overflow: hidden;
    }

    .modal-container {
      border-radius: 0.4em;
      padding: 1em;
      max-width: 50%;
    }

    .modal-title {
      padding: 0 1em;
      font-size: 1.75em;
      font-weight: 700;
    }

    .modal-body ol {
      margin: 0 0 0 1em;
      padding: 0;
    }

    .version {
      text-align: center;
      font-size: 1em;
      font-weight: 100;
      width: 100%;
    }

    .tutorial-title {
      font-size: 1.2em;
      font-weight: 700;
    }
  </style>

  <template>

    <!-- wrapper -->
    <paper-drawer-panel id="eAppShell" force-narrow="true" drawer-width="256px"
      disable-swipe="true" disable-edge-swipe="true">

      <!-- drawer -->
      <div drawer class="drawer vertical layout">
        <div class="app-title">Canopy</div>
        <div class="flex">
          <paper-item on-click="_onMenuAbout">About</paper-item>
          <paper-item on-click="_onMenuTutorial">Getting Started</paper-item>
          <paper-item>Canopy In-depth</paper-item>
        </div>
        <div class="about">
          <paper-item>
            <a href="https://github.com/hoch/canopy" target="_blank">
              <iron-icon icon="home" item-icon></iron-icon>
              <span>GitHub</span>
            </a>
          </paper-item>
          <paper-item>
            <a href="https://github.com/hoch/canopy/issues" target="_blank">
              <iron-icon icon="report-problem" item-icon></iron-icon>
              <span>Issue Tracker</span>
            </a>
          </paper-item>
        </div>
      </div>

      <!-- workspace -->
      <div main class="workspace">

        <div id="eWorkspace">

          <canopy-toolbar>
            <paper-icon-button icon="menu" on-click="_onMenu">
            </paper-icon-button>
            <span class="title">Canopy</span>
            <paper-icon-button icon="av:stop" on-click="_onAudioStop">
            </paper-icon-button>
            <paper-icon-button icon="av:play-arrow" on-click="_onAudioPlay">
            </paper-icon-button>
            <paper-icon-button id="eBtnLoop" icon="av:repeat" 
              on-click="_onAudioToggleLoop">
            </paper-icon-button>
            <span class="flex"></span>
          </canopy-toolbar>

          <div id="eWaveformView">
            <div>
              <spiral-minimap id="eMiniMap"></spiral-minimap>
            </div>
            <spiral-waveform id="eWaveform"></spiral-waveform>
          </div>

          <div id="eAudioGraphView">
            <spiral-audiograph id="eAudioGraph"></spiral-audiograph>
          </div>

        </div>

        <div id="eSplitter" on-track="_onSplitterDragged">
          <div class="splitter-handle"></div>
        </div>

        <div id="ePaneEditor">
          <div id="eTools">
            <paper-icon-button id="eBtnRender" icon="send" 
              on-click="_onBtnRender"></paper-icon-button>
            <paper-icon-button id="eBtnViewChange" icon="visibility" 
              on-click="_onBtnViewChange">
            </paper-icon-button>
            <div class="flex"></div>
            <paper-icon-button icon="description" 
              on-click="_onBtnOpenGistLoader">
            </paper-icon-button>
          </div>
          <spiral-coder id="eCoder"></spiral-coder>
        </div>

      </div>

    </paper-drawer-panel>

    <!-- Modal: About -->
    <paper-dialog id="eAboutModal" class="modal-container" modal>
      <div class="modal-title">About</div>
      <div class="modal-body">
        <p><a href="https://github.com/hoch/canopy" target="_blank">Canopy</a>
          is a set of Web Audio API programming tools. It offers:</p>
        <ul>
          <li>Interactive Waveform inspector with seamless zoom in/out.</li>
          <li>Interactive audiograph visualization.</li>
          <li>Web Audio API code editor with:
            <ul>
              <li>Auto completion</li>
              <li>Gist integration</li>
              <li>Embedded AudioContext configuration</li>
            </ul>
          </li>
          <li>Ranged playback with looping.</li>
        </ul>
        <p><a href="https://github.com/hoch/canopy" target="_blank">Canopy</a>
          is created by <a href="http://hoch.io" target="_blank">Hongchan Choi
          </a>for Chromium Web Audio API project with
          <a href="https://www.polymer-project.org/1.0/">Polymer</a> and
          <a href="https://github.com/hoch/spiral">Spiral</a>.</p>
        <p>For feedback, question, contribution or concern, please use
          <a href="https://github.com/hoch/canopy/issues" target="_blank">
          GitHub issue tracker</a>.</p>
        <div class="version">{{_version}}</div>
      </div>
      <div class="buttons">
        <paper-button dialog-confirm autofocus raised>Got it!</paper-button>
      </div>
    </paper-dialog>

    <!-- Modal: Tutorial -->
    <paper-dialog id="eTutorialModal" class="modal-container" modal>
      <div class="modal-title">Using Canopy</div>
      <div class="modal-body">
        <neon-animated-pages id="eTutorialPages" selected="0">
          <neon-animatable>
            <img src="images/step-1.png">
            <p class="tutorial-title">Write code or load a Gist.</p>
            <p>Load a code snippet from GitHub Gist by clicking the <strong>
              document icon</strong> at the bottom left.</p>
            <p>Or you can just write code in the editor.</p>
          </neon-animatable>
          <neon-animatable>
            <img src="images/step-2.png">
            <p class="tutorial-title">Render the code.</p>
            <p>Once you have valid codes in the editor, click the <strong>arrow
              icon</strong> to render it to the audio buffer. This will play the
              sound and draw the visualization.</p>
          </neon-animatable>
          <neon-animatable>
            <img src="images/step-3.png">
            <p class="tutorial-title">Inspect waveform.</p>
            <p>You can inspect the waveform by dragging the mouse around.</p>
            <p>Drag vertically to zoom in and out the time line, and
              horizontally to pan the view port.</p>
          </neon-animatable>
          <neon-animatable>
            <img src="images/step-4.png">
            <p class="tutorial-title">Navigate waveform.</p>
            <p>You can use the mini map to navigate the waveform faster.</p>
          </neon-animatable>
          <neon-animatable>
            <img src="images/step-5.png">
            <p class="tutorial-title">Play sound.</p>
            <p>The rendered audio buffer can be played without re-rendering.
              You can also loop the range selected by the view port.</p>
          </neon-animatable>
          <neon-animatable>
            <img src="images/step-6.png">
            <p class="tutorial-title">Change view mode.</p>
            <p>You can also inspect the graph after rendering the code.
              Clicking the eye icon will toggle the view mode between the
              waveform and the audio graph.</p>
          </neon-animatable>
          <neon-animatable>
            <img src="images/step-7.png">
            <p class="tutorial-title">Inspect audiograph.</p>
            <p>In the audio graph mode, you can zoom in and out by the mouse
              wheel, move by dragging and click a node or an edge to inspect
              AudioNode, AudioParam or even the connection.</p>
          </neon-animatable>
          <neon-animatable>
            <p class="tutorial-title">That's it!</p>
            <p>Have fun with Canopy!</p>
          </neon-animatable>
        </neon-animated-pages>
        <div class="buttons">
          <paper-button dialog-dismiss raised>Dismiss</paper-button>
          <paper-button autofocus raised on-click="_onTutorialNextStep">Next
          </paper-button>
        </div>
      </div>
    </paper-dialog>

    <!-- Modal: GistLoader -->
    <paper-dialog id="eLoaderModal" class="modal-container" modal>
      <div class="modal-title">Loading Gist</div>
      <spiral-gistloader id="eGistLoader" class="flex"></spiral-gistloader>
      <div class="buttons">
        <paper-button dialog-confirm autofocus raised>CLOSE</paper-button>
      </div>
    </paper-dialog>

  </template>

  <script>
    Polymer({
      is: 'canopy-app',

      properties: {

        _version: {
          type: String,
          value: '0.9.6-dev'
        },

        _currentView: {
          type: String,
          value: 'Waveform'
        },

        _workspaceHeight: {
          type: Number,
          value: 290
        },

        _editorHeight: Number,

        _minPaneHeight: {
          type: Number,
          value: 256
        },

        _resizeAsyncTask: Object,

        _currentTutorialStep: Number

      },

      behaviors: [
        Polymer.IronResizableBehavior
      ],


      // =======================================================================
      // Private methods.
      // =======================================================================

      // Initialize application.
      _initialize: function () {
        console.log('[canopy] initializing application: ' + performance.now());

        // Register children modules to the app shell.
        this.$.eWaveform.setController(this);
        this.$.eMiniMap.setController(this);
        this.$.eCoder.setController(this);

        // Define callbacks for onRenderComplete for spiral-coder.
        // this.$.eCoder.onRenderComplete = this._onRenderComplete.bind(this);
        this.$.eGistLoader.onGistLoaded = this._onGistLoaded.bind(this);

        // Default code snippet.
        this.$.eCoder.setCode(
          '// Press ARROW button on the tool bar left.\n' +
          '//\n' +
          '// @channels 1\n' +
          '// @duration 1.0\n' +
          '// @sampleRate 44100\n\n' +
          'var osc = context.createOscillator();\n' +
          'var gain = context.createGain();\n\n' +
          'osc.frequency.setValueAtTime(261.6, 0.0);\n' +
          'gain.gain.value = 0.5;\n\n' +
          'osc.connect(gain);\n' +
          'gain.connect(context.destination);\n\n' +
          'osc.start();\n' +
          'osc.stop(1.0);\n'
        );

        // Set pre/post code for graph visualization.
        this.$.eCoder.setPreCode('SpiralAudioGraphService.trackContext(context);');
        this.$.eCoder.setPostCode('SpiralAudioGraphService.draw();');

        // Initialize pane heights. 
        // TODO: This is a hack for 0 bounding box issue of Polymer element.
        this.async(this._resizePanes, 1);

        console.log('[canopy] Ready (' + this._version + '): ' 
          + performance.now());

        // This activates the developer mode.
        // this._DEV_activate();
      },

      // Resize components accordingly and propagate resize event to children
      // elements.
      _resizePanes: function () {
        if (this._resizeAsyncTask)
          this.cancelAsync(this._resizeAsyncTask);

        // Initial resizing: fetch the workspace height and calculate the editor
        // height.
        if (!this._editorHeight) {
          this._editorHeight = this.clientHeight - 42 - 16 - this._workspaceHeight;
        }

        // workspace H = total H - title bar H - splitter H - editor H.
        var workspaceHeight = this.clientHeight - 42 - 16 - this._editorHeight;

        this.$.eWorkspace.style.height = workspaceHeight + 'px';
        this.$.eWaveformView.style.height = workspaceHeight + 'px';
        this.$.eAudioGraphView.style.height = workspaceHeight + 'px';

        this.$.ePaneEditor.style.height = this._editorHeight + 'px';
        this.$.eTools.style.height = this._editorHeight + 'px';

        this._resizeAsyncTask = this.async(this.notifyResize, 16);
      },

      // Update the editor height based on the splitter movement.
      _updateEditorHeightByDelta: function (delta) {
        var maxEditorHeight = this.clientHeight - 42 - 16 - this._minPaneHeight;
        var newEditorHeight = this._editorHeight - delta;

        // Cannot exceed the max editor height.
        if (newEditorHeight >= maxEditorHeight) {
          this._editorHeight = maxEditorHeight;
          return;
        }

        // And cannot exceed the minimum pane height.
        if (newEditorHeight <= this._minPaneHeight) {
          this._editorHeight = this._minPaneHeight;
          return;
        }

        this._editorHeight = newEditorHeight;
        this._resizePanes();
      },


      // Activate DEV mode.
      _DEV_activate: function () {
        console.log('[canopy] Entering dev mode...');

        // Below you can put any thing that you want to test.
        // this._onMenuTutorial();
      },


      // =======================================================================
      // Event handlers: event, buttons, and interaction.
      // =======================================================================

      // When the splitter bar dragged. 
      _onSplitterDragged: function (event) {
        switch(event.detail.state) {
          case 'track':
            this.style.cursor = 'row-resize';
            this._updateEditorHeightByDelta(event.detail.ddy);
            break;
          case 'end':
            this.style.cursor = 'default';
            break;
        }
      },

      // When spiral-coder finishes rendering.
      _onRenderBufferToViews: function (buffer) {
        this.$.eWaveform.setAudioBuffer(buffer);
        this.$.eWaveform.setViewRange(0, buffer.duration * 0.25);
        this.$.eMiniMap.setAudioBuffer(buffer);
        this.$.eMiniMap.setRegion(0, buffer.duration * 0.25);
        CanopyAudio.setAudioBuffer(buffer);
      },

      // When spiral-gistloader loads a user-selected code snippet.
      _onGistLoaded: function (gist) {
        this.$.eCoder.setCode(gist.code);
      },

      // Main menu
      _onMenu: function () {
        this.$.eAppShell.openDrawer();
      },

      // Main menu > About
      _onMenuAbout: function () {
        this.$.eAboutModal.open();
      },

      // Main menu > Getting Started
      // TODO: needs to reset the state completely.
      _onMenuTutorial: function () {
        this._currentTutorialStep = 0;
        this.$.eTutorialPages.selected = '0';
        this.$.eTutorialModal.open();
      },

      // Tutorial > Next Step.
      _onTutorialNextStep: function () {
        if (this._currentTutorialStep++ > 6) {
          this.$.eTutorialModal.close();
          this.$.eTutorialPages.entryAnimation= '';
          this.$.eTutorialPages.exitAnimation = '';
          this._currentTutorialStep = 0;
          this.$.eTutorialPages.selected = 0;
          return;
        }

        this.$.eTutorialPages.entryAnimation= 'slide-from-right-animation';
        this.$.eTutorialPages.exitAnimation = 'fade-out-animation';
        this.$.eTutorialPages.selected = this._currentTutorialStep;
      },

      // Button: Render
      _onBtnRender: function () {
        // Clear the previous graph visualization.
        SpiralAudioGraphService.clear();
        this.$.eBtnRender.disabled = true;

        this.$.eCoder.renderAudioBuffer();
      },

      // Button: View Change
      _onBtnViewChange: function () {
        // Toggle the current view.
        this._currentView = this._currentView === 'Waveform' ? 
          'AudioGraph' : 'Waveform';
        var isWaveform = this._currentView === 'Waveform';
        this.$.eWaveformView.style.display = isWaveform ? 'block' : 'none';
        this.$.eAudioGraphView.style.display = isWaveform ? 'none' : 'block';

        // Forced resize.
        this.async(this.notifyResize, 1);
      },

      // Button: Gistloader
      _onBtnOpenGistLoader: function () {
        this.$.eLoaderModal.open();
      },

      // Audio: Stop
      _onAudioStop: function () {
        CanopyAudio.stop();
      },

      // Audio: Play
      _onAudioPlay: function () {
        var region = this.$.eMiniMap.getRegion();
        if (region)
          CanopyAudio.play(region.start, region.end);
      },

      // Audio: Loop Toggle
      _onAudioToggleLoop: function () {
        CanopyAudio.toggleLoop();

        if (CanopyAudio.loop)
          eBtnLoop.style.color = 'orange';
        else
          eBtnLoop.style.color = 'gray';
      },

      created: function () {},
      ready: function () {},

      // Built-in life cycle: entry point.
      attached: function () {
        this._initialize();
      },


      // =======================================================================
      // Public methods.
      // =======================================================================

      /**
       * Receives posted messages from other Spiral elements.
       * @param  {String} id   Spiral component ID
       * @param  {String} type Event type
       * @param  {Object} data Data
       */
      postMessage: function (id, type, data) {
        switch (id) {
          
          case 'spiral-minimap':
            this.$.eWaveform.setViewRange(data.start, data.end);
            break;
          
          case 'spiral-waveform':
            this.$.eMiniMap.setRegion(data.start, data.end);
            break;

          case 'spiral-coder':
            switch(type) {
              case 'canopy-render-complete':
                this._onRenderBufferToViews(data.buffer);
                break;
              case 'canopy-code-changed':
                this.$.eBtnRender.disabled = false;
                break;
            }
        }
      }
    });
  </script>

</dom-module>
