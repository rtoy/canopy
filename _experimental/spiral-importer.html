<!--
@license
MIT License. Copyright (c) 2015 Hongchan Choi. All rights reserved.
-->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-styles/paper-styles.html">

<!--
Import external JS code. Works as a container, code injector.

Example:

    <spiral-importer></spiral-importer>
-->
<dom-module id="spiral-importer">

  <style is="custom-style">
    :host {
      @apply(--layout);
      width: 100%;
      min-width: 320px;
      overflow: hidden;
    }

    .title {
      font-size: 1.1em;
      color: #999;
    }

    .url-input {
      margin-bottom: 0.45em;
      width: 100%;
      color: var(--google-blue-700);
      --paper-input-container-label: {
        color: var(--google-blue-700);
      };
      --paper-input-container-input: {
        font-size: 0.9em;
      };
      --paper-input-suffix: {
        line-height: 20px;
      };
    }

    .section-url-list paper-item {
      font-size: 0.9em;
      padding: 0;
      min-height: 2.5em;
    }

    .section-url-list .source-index {
      margin-right: 0.5em;
    }


  </style>

  <template>
    <div class="vertical layout">

      <div class="title">Import External Library</div>

      <paper-input id="eUrlInput" class="url-input" label="Add a new URL" always-float-label>
        <paper-icon-button suffix on-click="_onBtnAddUrl" icon="add">
        </paper-icon-button>
      </paper-input>

      <div class="flex">
        <paper-menu class="list section-url-list">
          <template id="eUrlList" is="dom-repeat" items="{{_data}}">
            <template is="dom-if" if="{{item.isValid}}">
              <paper-item>
                <span class="flex">{{item.url}}</span>
                <paper-icon-button icon="remove" on-click="_onBtnDeleteUrl"></paper-icon-button>
              </paper-item>
            </template>
          </template>
        </paper-menu>
      </div>

    </div>
  </template>

</dom-module>

<script>

  Polymer({

    is: 'spiral-importer',

    properties: {

      _data: {
        type: Array,
        value: [{
          url: 'https://raw.githubusercontent.com/hoch/spiral/master/spiral.min.js',
          source: null,
          isValid: false
        }]
      }

    },

    _initialize: function () {
      // Try to load and validate all script files.
      for (var i = 0; i < this._data.length; ++i)
        this._loadScriptViaXhr(i, this._data[i]);
    },

    _loadScriptViaXhr: function (index, item) {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', item.url, true);
      xhr.onreadystatechange = function (event) {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            this.set('_data.' + index + '.source', xhr.responseText);
            this.set('_data.' + index + '.isValid', true);
          } else {
            // TODO: handle errors.
          }
        }
      }.bind(this);

      xhr.send();
    },

    // Handle 'add button'.
    _onBtnAddUrl: function (event) {
      if(this.$.eUrlInput.value.length === 0)
        return;

      var newItem = {
        url: this.$.eUrlInput.value,
        source: null,
        isValid: false
      };

      this.push('_data', newItem);
      var newIndex = this._data.indexOf(newItem);
      this._loadScriptViaXhr(newIndex, newItem);

      this.$.eUrlInput.value = '';
    },

    // Handle 'delete button'.
    _onBtnDeleteUrl: function (event) {
      var index = this._data.indexOf(event.model);
      this.splice('_data', index, 1);
    },

    created: function () {},

    ready: function() {},

    attached: function() {
      this._initialize();
    },

    evaluateScripts: function () {
      for (var i = 0; i < this._data.length; ++i)
        (new Function(this._data[i].source))();
    }

  });

</script>
